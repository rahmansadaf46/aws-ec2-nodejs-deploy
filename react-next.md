# ğŸš€ Frontend & Next.js Deployment Templates (AWS EC2)

This repository documents **production-ready deployment patterns** for running React (Vite) and Next.js applications on an **AWS EC2 Ubuntu server** using:

- **systemd** (for server-based Next.js)
- **Nginx** (for static serving & reverse proxy)
- **Environment-based configuration**
- **Optional HTTPS (SSL)**

---

# ğŸ“¦ Part 1: Static Sites
**Use for:** React (Vite), Vue, Svelte, Next.js (`output: 'export'`)

## ğŸ§± Architecture Overview

```mermaid
Internet
|
|  http(s)://yourdomain.com
v
Nginx (Static File Server)
|
v
/var/www/your-app/dist (HTML/CSS/JS)
```

## ğŸ“ Directory Structure

Typically uploads the `dist` (Vite) or `out` (Next.js) folder to the server.

```
/var/www/
      â””â”€â”€ your-app-static/
              â”œâ”€â”€ index.html
              â”œâ”€â”€ assets/
              â”‚    â”œâ”€â”€ index-Xd2.js
              â”‚    â””â”€â”€ style-Y7s.css
              â”œâ”€â”€ public/
              â””â”€â”€ ...
```

## ğŸŒ Nginx Configuration (Static)

### Create Nginx Site

```bash
sudo nano /etc/nginx/sites-available/your-static-app
```

### Configuration Content

Handles SPA routing (React Router) by falling back to `index.html`.

```nginx
server {
    listen 80;
    server_name yourdomain.com SERVER_IP;

    root /var/www/your-app-static;
    index index.html;

    # Gzip settings for performance
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    location / {
        # First attempt to serve request as file, then
        # as directory, then fall back to displaying a 404.
        # For SPAs (React/Vue), fall back to index.html:
        try_files $uri $uri/ /index.html;
    }

    # Optional: Cache static assets
    location /assets/ {
        expires 1y;
        add_header Cache-Control "public, no-transform";
    }
}
```

### Enable & Start

```bash
sudo ln -s /etc/nginx/sites-available/your-static-app /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

# âš¡ Part 2: Next.js Server Deployment
**Use for:** Next.js (SSR, API Routes, ISR)

There are two main ways to run Next.js on a server:
1. **Standalone** (Recommended): optimizing bundle size, bundles `node_modules`.
2. **Default**: Standard `next start`, requires full `node_modules` installation on server.

## ğŸ§± Architecture Overview

```mermaid
Internet
|
|  http(s)://yourdomain.com
v
Nginx (Reverse Proxy)
|  proxy_pass (http://127.0.0.1:3000)
v
Next.js Service (systemd)
```

## ğŸ“ Option A: Next.js Standalone (Recommended)

Requires `output: 'standalone'` in `next.config.js`. Use this to avoid installing huge `node_modules` on the server.

### Directory Structure

```
/var/www/
      â””â”€â”€ your-next-app/
              â”œâ”€â”€ public/                  <-- Copy from project root
              â”œâ”€â”€ .next/
              â”‚     â””â”€â”€ static/            <-- Copy from .next/static
              â”œâ”€â”€ server.js                <-- Generated by build inside .next/standalone
              â”œâ”€â”€ package.json             <-- Generated inside .next/standalone
              â””â”€â”€ .env.production
```

**Wait, where do I put files?**
When you build local with `standalone`, Next.js creates `.next/standalone`.
1. Copy `.next/standalone/*` to `/var/www/your-next-app/`
2. Copy `public/` folder to `/var/www/your-next-app/public/`
3. Copy `.next/static/` folder to `/var/www/your-next-app/.next/static/`

### Systemd Service (Standalone)

```ini
[Unit]
Description=Next.js Standalone App
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/var/www/your-next-app
EnvironmentFile=/var/www/your-next-app/.env.production
# Standalone uses a minimal server.js
ExecStart=/usr/bin/node server.js

Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

## ğŸ“ Option B: Next.js Default (`next start`)

Standard deployment. Requires running `npm install` on the server.

### Directory Structure

```
/var/www/
      â””â”€â”€ your-next-app/
              â”œâ”€â”€ .next/
              â”œâ”€â”€ public/
              â”œâ”€â”€ package.json
              â”œâ”€â”€ node_modules/       <-- Created by npm install --omit=dev
              â””â”€â”€ .env.production
```

### Systemd Service (Default)

```ini
[Unit]
Description=Next.js App
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/var/www/your-next-app
EnvironmentFile=/var/www/your-next-app/.env.production

# Make sure 'next' is available or use full path to node_modules binary
ExecStart=/usr/bin/npm start
# OR direct node call (more reliable)
# ExecStart=/var/www/your-next-app/node_modules/.bin/next start

Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

---

## ğŸŒ Nginx Configuration (Reverse Proxy for Next.js)

Same for both Standalone and Default modes.

### Create Nginx Site

```bash
sudo nano /etc/nginx/sites-available/your-next-app
```

### Configuration Content

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    location / {
        proxy_pass http://127.0.0.1:3000; # Default request port
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Next.js specific cache bypass for API/HMR
        proxy_cache_bypass $http_upgrade;
    }
}
```

---

# ğŸ” Common Setup: HTTPS (SSL)

Run Certbot after setting up Nginx for either Static or Server methods.

```bash
# 1. Install Certbot
sudo apt update
sudo apt install certbot python3-certbot-nginx -y

# 2. Generate Cert
sudo certbot --nginx -d yourdomain.com
```

# ğŸ” Deployment Cheat Sheet

### Static (React/Vite)
1. Local: `npm run build`
2. Local: `rsync -avz dist/ user@server:/var/www/your-app-static`
3. Server: No restart needed (Nginx serves files immediately).

### Next.js Standalone
1. Local: `npm run build`
2. Local: Copy `.next/standalone`, `public`, and `.next/static` to server.
3. Server: `sudo systemctl restart your-next-app`

### Next.js Default
1. Local: `npm run build`
2. Local: Copy `.next`, `public`, `package.json` to server.
3. Server: `npm install --omit=dev`
4. Server: `sudo systemctl restart your-next-app`

